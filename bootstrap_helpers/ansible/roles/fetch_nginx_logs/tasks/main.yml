- set_fact:
    start_epoch: "{{(query |to_datetime).strftime('%s') | int }}"
  vars:  
    query: "{{log_start_date}} {{log_start_time}}:00"
  delegate_to: 127.0.0.1

- set_fact:
    end_epoch: "{{(query |to_datetime).strftime('%s') | int }}"
  vars:  
    query: "{{log_end_date}} {{log_end_time}}:00"
  delegate_to: 127.0.0.1

- debug:
    var: start_epoch

- debug:
    var: end_epoch

- find:
    paths: "{{apigee_log_dir}}/edge-router/nginx"
    patterns: '{{org}}~{{env}}*access_log,{{org}}~{{env}}*.gz'
  register: logs

- set_fact:
    filtered_access_logs: []

- block:
  - name:
    shell: "date -d \"$(zcat -f {{item.path}} | head -1 | cut -d$'\t' -f1)\" +%s"
    register: st

  - name:
    shell: "date -d \"$(zcat -f {{item.path}} | tail -1 | cut -d$'\t' -f1)\" +%s"
    register: et

  - set_fact:
      filtered_access_logs: "{{ filtered_access_logs  }} + {{item.path}}"
    when: ( st.stdout > start_epoch and et.stdout < end_epoch ) or ( st.stdout == start_epoch and et.stdout == end_epoch )
  loop: "{{logs.files}}"

- debug:
    var: filtered_access_logs